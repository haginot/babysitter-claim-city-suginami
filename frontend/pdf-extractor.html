<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 1: PDF/é ˜åæ›¸ã‹ã‚‰åˆ©ç”¨çŠ¶æ³ã‚’æŠ½å‡º - æ‰ä¸¦åŒºãƒ™ãƒ“ãƒ¼ã‚·ãƒƒã‚¿ãƒ¼åˆ©ç”¨æ”¯æ´ç”³è«‹</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }

        .upload-section.dragover {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #45a049;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .hint-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
            color: #2e7d32;
        }

        .hint-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .extract-btn {
            display: inline-block;
            padding: 12px 40px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .extract-btn:hover:not(:disabled) {
            background-color: #1976D2;
        }

        .extract-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            padding: 15px;
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .error.active {
            display: block;
        }

        .success {
            display: none;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success.active {
            display: block;
        }

        /* PDFçµæœã‚«ãƒ¼ãƒ‰ */
        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h2 {
            font-size: 18px;
            color: #333;
        }

        .pdf-results {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pdf-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .pdf-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .pdf-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .pdf-card-title .icon {
            font-size: 20px;
        }

        .format-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .format-badge.kidsline {
            background: #e3f2fd;
            color: #1565c0;
        }

        .format-badge.invoice {
            background: #fff3e0;
            color: #e65100;
        }

        .pdf-card-body {
            padding: 15px 20px;
        }

        .pdf-card-info {
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table thead {
            background-color: #4CAF50;
            color: white;
        }

        table th,
        table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .pdf-card-error {
            color: #c62828;
            background: #ffebee;
            padding: 15px;
            border-radius: 4px;
        }

        .pdf-card-actions {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
        }

        .btn-remove {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove:hover {
            background: #d32f2f;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            padding: 12px 40px;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #45a049;
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976D2;
        }

        .navigation {
            margin-bottom: 20px;
        }

        /* ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
        details {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        summary {
            cursor: pointer;
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <div style="color: #2196F3; font-weight: bold; margin-bottom: 10px;">Step 1 / 3</div>
        </div>

        <h1>PDF/é ˜åæ›¸ã‹ã‚‰åˆ©ç”¨çŠ¶æ³ã‚’æŠ½å‡º</h1>
        <p class="subtitle">PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨è‡ªå‹•ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’åˆ¤åˆ¥ã—ã¾ã™</p>

        <div class="hint-box">
            <strong>å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</strong>
            <ul style="margin-left: 20px; margin-top: 5px;">
                <li><strong>è«‹æ±‚æ›¸å½¢å¼</strong>: è¤‡æ•°ã®åˆ©ç”¨æ˜ç´°ãŒ1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¾ã¨ã¾ã£ã¦ã„ã‚‹PDF</li>
                <li><strong>ã‚­ãƒƒã‚ºãƒ©ã‚¤ãƒ³é ˜åæ›¸</strong>: 1å›ã®åˆ©ç”¨ã”ã¨ã«ç™ºè¡Œã•ã‚Œã‚‹ã€Œé ˜åæ›¸ å…¼ åˆ©ç”¨æ˜ç´°æ›¸ã€PDF</li>
            </ul>
        </div>

        <div class="error" id="errorMessage"></div>
        <div class="success" id="successMessage"></div>

        <div class="upload-section" id="uploadSection">
            <label for="fileInput" class="file-input-label">
                PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰
            </label>
            <input type="file" id="fileInput" accept=".pdf" multiple>
            <div class="file-info" id="fileInfo">
                ã¾ãŸã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            </div>
        </div>

        <div style="text-align: center;">
            <button class="extract-btn" id="extractBtn" disabled>ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">PDFã‚’è§£æä¸­...</p>
        </div>

        <!-- æŠ½å‡ºçµæœ -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>æŠ½å‡ºçµæœ</h2>
                <span id="resultsSummary"></span>
            </div>

            <div class="pdf-results" id="pdfResults">
                <!-- PDFã”ã¨ã®çµæœã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>

            <div class="actions">
                <button class="btn btn-secondary" id="addMoreBtn">+ PDFã‚’è¿½åŠ </button>
                <button class="btn btn-primary" id="nextToEditorBtn" disabled>æ¬¡ã¸: JSONã‚’ç·¨é›† â†’</button>
            </div>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <details style="margin-top: 20px;">
            <summary>ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³</summary>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="exportCsvBtn" style="font-size: 12px;" disabled>CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-secondary" id="copyBtn" style="font-size: 12px;" disabled>ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
            </div>
        </details>
    </div>

    <script>
        // æŠ½å‡ºçµæœã‚’ä¿å­˜
        let extractedResults = [];

        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const extractBtn = document.getElementById('extractBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const resultsSection = document.getElementById('resultsSection');
        const pdfResults = document.getElementById('pdfResults');
        const resultsSummary = document.getElementById('resultsSummary');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const nextToEditorBtn = document.getElementById('nextToEditorBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const copyBtn = document.getElementById('copyBtn');

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleFileSelect(files);
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            if (files.length > 0) {
                // FileListã‚’inputã«ã‚»ãƒƒãƒˆï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
                const dt = new DataTransfer();
                files.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
                handleFileSelect(files);
            } else {
                showError('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
            }
        });

        function handleFileSelect(files) {
            if (files.length === 1) {
                fileInfo.textContent = `é¸æŠ: ${files[0].name} (${formatFileSize(files[0].size)})`;
            } else {
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                fileInfo.textContent = `${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (åˆè¨ˆ: ${formatFileSize(totalSize)})`;
            }
            extractBtn.disabled = false;
            hideMessages();
        }

        // æŠ½å‡ºãƒœã‚¿ãƒ³
        extractBtn.addEventListener('click', async function() {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            await extractAllPdfs(files);
        });

        // è¿½åŠ ãƒœã‚¿ãƒ³
        addMoreBtn.addEventListener('click', function() {
            fileInput.click();
        });

        // è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        fileInput.addEventListener('change', async function(e) {
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
            if (resultsSection.classList.contains('active')) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    await extractAllPdfs(files, true);
                }
            }
        });

        async function extractAllPdfs(files, isAppend = false) {
            hideMessages();
            loading.classList.add('active');

            if (!isAppend) {
                extractedResults = [];
                pdfResults.innerHTML = '';
            }

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                loadingText.textContent = `PDFã‚’è§£æä¸­... (${i + 1}/${files.length}): ${file.name}`;

                try {
                    const result = await extractSinglePdf(file);
                    
                    if (result.success) {
                        extractedResults.push(result);
                        addResultCard(result);
                        successCount++;
                    } else {
                        addErrorCard(file.name, result.error, result.format);
                        errorCount++;
                    }
                } catch (error) {
                    addErrorCard(file.name, error.message);
                    errorCount++;
                }
            }

            loading.classList.remove('active');
            resultsSection.classList.add('active');

            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            updateSummary();

            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
            nextToEditorBtn.disabled = extractedResults.length === 0;
            exportCsvBtn.disabled = extractedResults.length === 0;
            copyBtn.disabled = extractedResults.length === 0;

            if (successCount > 0) {
                showSuccess(`${successCount}ä»¶ã®PDFã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¾ã—ãŸ${errorCount > 0 ? `ï¼ˆ${errorCount}ä»¶å¤±æ•—ï¼‰` : ''}`);
            } else {
                showError('ã™ã¹ã¦ã®PDFã§ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
            fileInfo.textContent = 'ã¾ãŸã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—';
            extractBtn.disabled = true;
        }

        async function extractSinglePdf(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/extract-auto', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                return {
                    success: false,
                    error: data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    format: data.format,
                    filename: file.name
                };
            }

            return data;
        }

        function addResultCard(result) {
            const card = document.createElement('div');
            card.className = 'pdf-card';
            card.dataset.filename = result.filename;

            const formatLabel = result.format === 'kidsline' ? 'ã‚­ãƒƒã‚ºãƒ©ã‚¤ãƒ³é ˜åæ›¸' : 'è«‹æ±‚æ›¸å½¢å¼';
            const formatClass = result.format === 'kidsline' ? 'kidsline' : 'invoice';
            const icon = result.format === 'kidsline' ? 'ğŸ§¾' : 'ğŸ“‹';

            let infoText = `${result.rows}è¡Œ Ã— ${result.columns}åˆ—`;
            if (result.child_name) {
                infoText += ` | ãŠå­æ§˜: ${result.child_name}`;
            }
            if (result.sitter_name) {
                infoText += ` | ã‚·ãƒƒã‚¿ãƒ¼: ${result.sitter_name}`;
            }

            card.innerHTML = `
                <div class="pdf-card-header">
                    <div class="pdf-card-title">
                        <span class="icon">${icon}</span>
                        <span>${result.filename}</span>
                    </div>
                    <span class="format-badge ${formatClass}">${formatLabel}</span>
                </div>
                <div class="pdf-card-body">
                    <div class="pdf-card-info">${infoText}</div>
                    <div class="table-container">
                        ${createTableHtml(result.table)}
                    </div>
                </div>
                <div class="pdf-card-actions">
                    <button class="btn-remove" onclick="removeResult('${result.filename}')">å‰Šé™¤</button>
                </div>
            `;

            pdfResults.appendChild(card);
        }

        function addErrorCard(filename, error, format) {
            const card = document.createElement('div');
            card.className = 'pdf-card';

            const formatLabel = format === 'kidsline' ? 'ã‚­ãƒƒã‚ºãƒ©ã‚¤ãƒ³é ˜åæ›¸' : (format === 'invoice' ? 'è«‹æ±‚æ›¸å½¢å¼' : 'ä¸æ˜');

            card.innerHTML = `
                <div class="pdf-card-header">
                    <div class="pdf-card-title">
                        <span class="icon">âŒ</span>
                        <span>${filename}</span>
                    </div>
                    ${format ? `<span class="format-badge ${format}">${formatLabel}</span>` : ''}
                </div>
                <div class="pdf-card-body">
                    <div class="pdf-card-error">${error}</div>
                </div>
            `;

            pdfResults.appendChild(card);
        }

        function createTableHtml(table) {
            if (!table || table.length === 0) return '<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>';

            let html = '<table><thead><tr>';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = table[0];
            header.forEach(cell => {
                html += `<th>${escapeHtml(cell || '')}</th>`;
            });
            html += '</tr></thead><tbody>';

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (let i = 1; i < table.length; i++) {
                html += '<tr>';
                table[i].forEach(cell => {
                    html += `<td>${escapeHtml(cell || '')}</td>`;
                });
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        function removeResult(filename) {
            // çµæœã‹ã‚‰å‰Šé™¤
            extractedResults = extractedResults.filter(r => r.filename !== filename);
            
            // ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            const card = pdfResults.querySelector(`[data-filename="${filename}"]`);
            if (card) {
                card.remove();
            }

            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            updateSummary();

            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            nextToEditorBtn.disabled = extractedResults.length === 0;
            exportCsvBtn.disabled = extractedResults.length === 0;
            copyBtn.disabled = extractedResults.length === 0;

            if (extractedResults.length === 0) {
                resultsSection.classList.remove('active');
            }
        }

        function updateSummary() {
            const totalRows = extractedResults.reduce((sum, r) => sum + (r.rows - 1), 0); // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ã
            
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ¥ã®ä»¶æ•°ã‚’é›†è¨ˆ
            const kidslineCount = extractedResults.filter(r => r.format === 'kidsline').length;
            const invoiceCount = extractedResults.filter(r => r.format === 'invoice').length;
            
            let formatInfo = '';
            if (kidslineCount > 0 && invoiceCount > 0) {
                formatInfo = `ï¼ˆğŸ§¾é ˜åæ›¸${kidslineCount}ä»¶ + ğŸ“‹è«‹æ±‚æ›¸${invoiceCount}ä»¶ï¼‰`;
            } else if (kidslineCount > 0) {
                formatInfo = `ï¼ˆğŸ§¾ã‚­ãƒƒã‚ºãƒ©ã‚¤ãƒ³é ˜åæ›¸ï¼‰`;
            } else if (invoiceCount > 0) {
                formatInfo = `ï¼ˆğŸ“‹è«‹æ±‚æ›¸å½¢å¼ï¼‰`;
            }
            
            resultsSummary.textContent = `${extractedResults.length}ä»¶ã®PDF${formatInfo}ã€åˆè¨ˆ${totalRows}è¡Œã®ãƒ‡ãƒ¼ã‚¿`;
        }

        // æ¬¡ã¸ãƒœã‚¿ãƒ³
        nextToEditorBtn.addEventListener('click', async function() {
            if (extractedResults.length === 0) {
                showError('æŠ½å‡ºçµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                loading.classList.add('active');
                loadingText.textContent = 'JSONã«å¤‰æ›ä¸­...';

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆ
                const mergedTable = mergeExtractedTables(extractedResults);

                // JSONå¤‰æ›APIã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/api/convert-to-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: mergedTable
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'JSONå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                if (data.success && data.data) {
                    // æŠ½å‡ºçµæœã‚‚ä¿å­˜ï¼ˆStep2ã§è¡¨ç¤ºç”¨ï¼‰
                    localStorage.setItem('extractedTableData', JSON.stringify({
                        results: extractedResults,
                        mergedTable: mergedTable
                    }));
                    localStorage.setItem('extractedFormData', JSON.stringify(data.data));
                    window.location.href = '/frontend/json-editor.html';
                } else {
                    throw new Error('å¤‰æ›çµæœãŒç„¡åŠ¹ã§ã™');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                loading.classList.remove('active');
            }
        });

        function mergeExtractedTables(results) {
            if (results.length === 0) return [];

            // æœ€åˆã®çµæœã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
            const header = results[0].table[0];
            const mergedTable = [header];

            // å„çµæœã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
            for (const result of results) {
                for (let i = 1; i < result.table.length; i++) {
                    mergedTable.push(result.table[i]);
                }
            }

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿è¡Œã®ã¿ï¼‰
            const dataRows = mergedTable.slice(1);
            dataRows.sort((a, b) => {
                const dateA = a[0] || '';
                const dateB = b[0] || '';
                return dateA.localeCompare(dateB);
            });

            return [header, ...dataRows];
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        exportCsvBtn.addEventListener('click', function() {
            if (extractedResults.length === 0) return;

            const mergedTable = mergeExtractedTables(extractedResults);
            const csv = mergedTable.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'extracted_table.csv';
            link.click();

            showSuccess('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        });

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        copyBtn.addEventListener('click', async function() {
            if (extractedResults.length === 0) return;

            const mergedTable = mergeExtractedTables(extractedResults);
            const text = mergedTable.map(row => row.join('\t')).join('\n');

            try {
                await navigator.clipboard.writeText(text);
                showSuccess('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch (error) {
                showError('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            successMessage.classList.remove('active');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('active');
            errorMessage.classList.remove('active');
        }

        function hideMessages() {
            errorMessage.classList.remove('active');
            successMessage.classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
