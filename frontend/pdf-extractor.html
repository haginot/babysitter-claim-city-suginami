<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF テーブル抽出ツール</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background-color: #fafafa;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }

        .upload-section.dragover {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #45a049;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .extract-btn {
            display: inline-block;
            padding: 12px 40px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .extract-btn:hover:not(:disabled) {
            background-color: #1976D2;
        }

        .extract-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            padding: 15px;
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .error.active {
            display: block;
        }

        .success {
            display: none;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success.active {
            display: block;
        }

        .table-preview {
            display: none;
            margin-top: 30px;
        }

        .table-preview.active {
            display: block;
        }

        .table-preview h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .table-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        table thead {
            background-color: #4CAF50;
            color: white;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976D2;
        }

        .navigation {
            margin-bottom: 20px;
        }

        .navigation a {
            color: #2196F3;
            text-decoration: none;
            font-size: 14px;
        }

        .navigation a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="/frontend/babysitter-form.html">← 申請書フォームに戻る</a>
        </div>

        <h1>PDF テーブル抽出ツール</h1>
        <p class="subtitle">請求書PDFから「ご利用日」テーブルを抽出してプレビューします</p>

        <div class="error" id="errorMessage"></div>
        <div class="success" id="successMessage"></div>

        <div class="upload-section" id="uploadSection">
            <label for="fileInput" class="file-input-label">
                PDFファイルを選択（複数可）
            </label>
            <input type="file" id="fileInput" accept=".pdf" multiple>
            <div class="file-info" id="fileInfo">
                または、ファイルをここにドラッグ&ドロップ（複数可）
            </div>
        </div>

        <div style="text-align: center;">
            <button class="extract-btn" id="extractBtn" disabled>テーブルを抽出して連結</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>PDFを解析中...</p>
        </div>

        <div class="table-preview" id="tablePreview">
            <h2>抽出結果</h2>
            <div class="table-info" id="tableInfo"></div>
            <div class="table-container">
                <table id="previewTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="actions">
                <button class="btn btn-primary" id="exportCsvBtn">CSVでエクスポート</button>
                <button class="btn btn-secondary" id="copyBtn">クリップボードにコピー</button>
                <button class="btn btn-secondary" id="convertJsonBtn">JSONに変換してダウンロード</button>
                <button class="btn btn-secondary" id="editJsonBtn">JSONに変換して編集</button>
                <button class="btn btn-secondary" id="loadToFormBtn">JSONに変換して申請書に読み込む</button>
            </div>
        </div>

        <!-- JSON編集モーダル -->
        <div id="jsonEditorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; overflow: auto;">
            <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 8px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <h2 style="margin-top: 0;">JSONデータを編集</h2>
                <p style="color: #666; margin-bottom: 20px;">年度、申請者名、児童名などを編集できます</p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">年度（令和）</label>
                    <input type="text" id="editYear" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">申請者名</label>
                    <input type="text" id="editApplicantName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">児童名</label>
                    <input type="text" id="editChildName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">JSONデータ（上級者向け）</label>
                    <textarea id="editJsonData" style="width: 100%; height: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="cancelEditBtn" class="btn" style="background: #999; color: white;">キャンセル</button>
                    <button id="downloadEditedJsonBtn" class="btn btn-primary">ダウンロード</button>
                    <button id="loadEditedJsonBtn" class="btn btn-secondary">申請書に読み込む</button>
                </div>
            </div>
        </div>

        <div class="table-preview" id="debugPreview" style="display: none;">
            <h2>デバッグ情報（抽出されたすべてのテーブル）</h2>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        let extractedData = null;

        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const extractBtn = document.getElementById('extractBtn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const tablePreview = document.getElementById('tablePreview');
        const tableInfo = document.getElementById('tableInfo');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const copyBtn = document.getElementById('copyBtn');
        const convertJsonBtn = document.getElementById('convertJsonBtn');
        const editJsonBtn = document.getElementById('editJsonBtn');
        const loadToFormBtn = document.getElementById('loadToFormBtn');

        // JSON編集モーダル関連
        const jsonEditorModal = document.getElementById('jsonEditorModal');
        const editYear = document.getElementById('editYear');
        const editApplicantName = document.getElementById('editApplicantName');
        const editChildName = document.getElementById('editChildName');
        const editJsonData = document.getElementById('editJsonData');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const downloadEditedJsonBtn = document.getElementById('downloadEditedJsonBtn');
        const loadEditedJsonBtn = document.getElementById('loadEditedJsonBtn');

        let currentJsonData = null;

        // ファイル選択時
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleFileSelect(files);
            }
        });

        // ドラッグ&ドロップ
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            if (files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(files);
            } else {
                showError('PDFファイルのみアップロード可能です');
            }
        });

        function handleFileSelect(files) {
            if (files.length === 1) {
                fileInfo.textContent = `選択されたファイル: ${files[0].name} (${formatFileSize(files[0].size)})`;
            } else {
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                fileInfo.textContent = `${files.length}個のファイルを選択 (合計: ${formatFileSize(totalSize)})`;
            }
            extractBtn.disabled = false;
            hideMessages();
        }

        // 抽出ボタンクリック
        extractBtn.addEventListener('click', async function() {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                showError('ファイルを選択してください');
                return;
            }

            await extractAndConcatTables(files);
        });

        async function extractAndConcatTables(files) {
            hideMessages();
            loading.classList.add('active');
            tablePreview.classList.remove('active');
            const debugPreview = document.getElementById('debugPreview');
            debugPreview.style.display = 'none';

            try {
                const allTables = [];
                let commonHeader = null;

                // 各PDFからテーブルを抽出
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    loading.querySelector('p').textContent = `PDFを解析中... (${i + 1}/${files.length})`;

                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/extract-table', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        if (data.debug) {
                            displayDebugInfo(data.debug);
                        }
                        throw new Error(`${file.name}: ${data.error || 'エラーが発生しました'}`);
                    }

                    if (data.success && data.table && data.table.length > 0) {
                        // 最初のファイルからヘッダーを保存
                        if (i === 0) {
                            commonHeader = data.table[0];
                            allTables.push(data.table[0]); // ヘッダー行を追加
                        }

                        // データ行のみを追加（ヘッダー行をスキップ）
                        for (let j = 1; j < data.table.length; j++) {
                            allTables.push(data.table[j]);
                        }
                    }
                }

                if (allTables.length === 0) {
                    throw new Error('テーブルが抽出できませんでした');
                }

                // 連結したテーブルを表示
                extractedData = allTables;
                displayTable(allTables, allTables.length, allTables[0].length);
                showSuccess(`${files.length}個のPDFからテーブルを抽出・連結しました（${allTables.length}行 × ${allTables[0].length}列）`);

            } catch (error) {
                showError(error.message);
            } finally {
                loading.classList.remove('active');
                loading.querySelector('p').textContent = 'PDFを解析中...';
            }
        }

        async function extractTable(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/extract-table', {
                method: 'POST',
                body: formData
            });

            return await response.json();
        }

        function displayDebugInfo(debug) {
            const debugPreview = document.getElementById('debugPreview');
            const debugContent = document.getElementById('debugContent');

            if (!debug || !debug.all_tables) {
                return;
            }

            let html = `<p style="margin-bottom: 20px; color: #666;">PDFから ${debug.tables_found} 個のテーブルが見つかりました</p>`;

            debug.all_tables.forEach((tableInfo, idx) => {
                html += `
                    <div style="margin-bottom: 30px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f9f9f9;">
                        <h3 style="margin-bottom: 10px; font-size: 16px;">テーブル ${tableInfo.table_index + 1} (${tableInfo.rows}行 × ${tableInfo.columns}列)</h3>
                        <div class="table-container">
                            <table style="font-size: 12px; width: 100%;">
                                <tbody>
                `;

                tableInfo.data.forEach((row, rowIdx) => {
                    html += '<tr>';
                    row.forEach((cell, cellIdx) => {
                        const cellContent = cell || '(空)';
                        const normalized = cellContent.replace(/\s/g, '');
                        const highlight = (normalized.includes('ご利用日') ||
                                          normalized.includes('ご利⽤⽇') ||
                                          normalized.includes('利用日') ||
                                          normalized.includes('利⽤⽇')) ?
                                          'background: yellow; font-weight: bold;' : '';
                        html += `<td style="border: 1px solid #ddd; padding: 8px; ${highlight}">${cellContent}</td>`;
                    });
                    html += '</tr>';
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            debugContent.innerHTML = html;
            debugPreview.style.display = 'block';
        }

        function displayTable(table, rows, columns) {
            if (!table || table.length === 0) {
                showError('テーブルデータが空です');
                return;
            }

            // テーブル情報を表示
            tableInfo.textContent = `${rows}行 × ${columns}列のテーブル`;

            // ヘッダー行を設定
            const headerRow = table[0];
            tableHead.innerHTML = '';
            const headerTr = document.createElement('tr');
            headerRow.forEach(cell => {
                const th = document.createElement('th');
                th.textContent = cell || '';
                headerTr.appendChild(th);
            });
            tableHead.appendChild(headerTr);

            // データ行を設定
            tableBody.innerHTML = '';
            for (let i = 1; i < table.length; i++) {
                const row = table[i];
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            }

            tablePreview.classList.add('active');
        }

        // CSVエクスポート
        exportCsvBtn.addEventListener('click', function() {
            if (!extractedData) return;

            const csv = extractedData.map(row =>
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'extracted_table.csv';
            link.click();

            showSuccess('CSVファイルをダウンロードしました');
        });

        // クリップボードにコピー
        copyBtn.addEventListener('click', async function() {
            if (!extractedData) return;

            const text = extractedData.map(row => row.join('\t')).join('\n');

            try {
                await navigator.clipboard.writeText(text);
                showSuccess('クリップボードにコピーしました');
            } catch (error) {
                showError('コピーに失敗しました');
            }
        });

        // JSONに変換してダウンロード
        convertJsonBtn.addEventListener('click', async function() {
            if (!extractedData) return;

            try {
                loading.classList.add('active');
                loading.querySelector('p').textContent = 'JSONに変換中...';

                const response = await fetch('/api/convert-to-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: extractedData
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'JSON変換に失敗しました');
                }

                if (data.success && data.data) {
                    // JSONファイルをダウンロード
                    const jsonString = JSON.stringify(data.data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'form_data.json';
                    link.click();

                    showSuccess('JSONファイルをダウンロードしました');
                } else {
                    throw new Error('変換結果が無効です');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                loading.classList.remove('active');
                loading.querySelector('p').textContent = 'PDFを解析中...';
            }
        });

        // JSONに変換して編集
        editJsonBtn.addEventListener('click', async function() {
            if (!extractedData) return;

            try {
                loading.classList.add('active');
                loading.querySelector('p').textContent = 'JSONに変換中...';

                const response = await fetch('/api/convert-to-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: extractedData
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'JSON変換に失敗しました');
                }

                if (data.success && data.data) {
                    // JSONデータを保存して編集モーダルを表示
                    currentJsonData = data.data;
                    editYear.value = data.data.year || '7';
                    editApplicantName.value = data.data.applicantName || '';
                    editChildName.value = data.data.childName || '';
                    editJsonData.value = JSON.stringify(data.data, null, 2);
                    jsonEditorModal.style.display = 'block';
                } else {
                    throw new Error('変換結果が無効です');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                loading.classList.remove('active');
                loading.querySelector('p').textContent = 'PDFを解析中...';
            }
        });

        // JSON編集モーダル - キャンセルボタン
        cancelEditBtn.addEventListener('click', function() {
            jsonEditorModal.style.display = 'none';
            currentJsonData = null;
        });

        // JSON編集モーダル - フィールド編集時にJSONを更新
        function updateJsonFromFields() {
            if (!currentJsonData) return;

            try {
                // テキストエリアのJSONをパース
                const jsonData = JSON.parse(editJsonData.value);

                // フィールドの値で上書き
                jsonData.year = editYear.value;
                jsonData.applicantName = editApplicantName.value;
                jsonData.childName = editChildName.value;

                // 更新したJSONをテキストエリアに反映
                currentJsonData = jsonData;
                editJsonData.value = JSON.stringify(jsonData, null, 2);
            } catch (error) {
                // JSONパースエラーは無視（ユーザーが手動で編集中の可能性）
            }
        }

        editYear.addEventListener('change', updateJsonFromFields);
        editApplicantName.addEventListener('change', updateJsonFromFields);
        editChildName.addEventListener('change', updateJsonFromFields);

        // JSON編集モーダル - ダウンロードボタン
        downloadEditedJsonBtn.addEventListener('click', function() {
            try {
                // テキストエリアから最新のJSONを取得
                const jsonData = JSON.parse(editJsonData.value);

                // フィールドの値で上書き
                jsonData.year = editYear.value;
                jsonData.applicantName = editApplicantName.value;
                jsonData.childName = editChildName.value;

                // JSONファイルをダウンロード
                const jsonString = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'form_data.json';
                link.click();

                showSuccess('JSONファイルをダウンロードしました');
                jsonEditorModal.style.display = 'none';
            } catch (error) {
                alert('JSONの形式が正しくありません: ' + error.message);
            }
        });

        // JSON編集モーダル - 申請書に読み込むボタン
        loadEditedJsonBtn.addEventListener('click', function() {
            try {
                // テキストエリアから最新のJSONを取得
                const jsonData = JSON.parse(editJsonData.value);

                // フィールドの値で上書き
                jsonData.year = editYear.value;
                jsonData.applicantName = editApplicantName.value;
                jsonData.childName = editChildName.value;

                // JSONデータをlocalStorageに保存
                localStorage.setItem('extractedFormData', JSON.stringify(jsonData));

                // 申請書ページにリダイレクト
                window.location.href = '/frontend/babysitter-form.html?loadExtracted=true';
            } catch (error) {
                alert('JSONの形式が正しくありません: ' + error.message);
            }
        });

        // JSONに変換して申請書に読み込む（編集なし）
        loadToFormBtn.addEventListener('click', async function() {
            if (!extractedData) return;

            try {
                loading.classList.add('active');
                loading.querySelector('p').textContent = 'JSONに変換中...';

                const response = await fetch('/api/convert-to-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: extractedData
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'JSON変換に失敗しました');
                }

                if (data.success && data.data) {
                    // JSONデータをlocalStorageに保存
                    localStorage.setItem('extractedFormData', JSON.stringify(data.data));

                    // 申請書ページにリダイレクト
                    window.location.href = '/frontend/babysitter-form.html?loadExtracted=true';
                } else {
                    throw new Error('変換結果が無効です');
                }

            } catch (error) {
                showError(error.message);
            } finally {
                loading.classList.remove('active');
                loading.querySelector('p').textContent = 'PDFを解析中...';
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            successMessage.classList.remove('active');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('active');
            errorMessage.classList.remove('active');
        }

        function hideMessages() {
            errorMessage.classList.remove('active');
            successMessage.classList.remove('active');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
