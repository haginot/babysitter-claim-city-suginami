<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 2: JSONãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›† - æ‰ä¸¦åŒºãƒ™ãƒ“ãƒ¼ã‚·ãƒƒã‚¿ãƒ¼åˆ©ç”¨æ”¯æ´ç”³è«‹</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .navigation {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigation a {
            color: #2196F3;
            text-decoration: none;
            font-size: 14px;
        }

        .navigation a:hover {
            text-decoration: underline;
        }

        .step-indicator {
            color: #2196F3;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .column {
            min-width: 0;
        }

        .column h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .table-preview {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            background: #f5f5f5;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        table thead {
            background-color: #4CAF50;
            color: white;
            position: sticky;
            top: 0;
        }

        table th,
        table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
        }

        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #e3f2fd;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #2196F3;
        }

        input.error {
            border-color: #f44336;
        }

        textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            min-height: 300px;
            resize: vertical;
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .validation-status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .validation-status.valid {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .validation-status.invalid {
            background-color: #ffebee;
            color: #c62828;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: space-between;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back {
            background-color: #999;
            color: white;
        }

        .btn-back:hover {
            background-color: #777;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            padding: 12px 40px;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box p {
            margin: 5px 0;
            color: #1976D2;
        }

        /* ã‚µãƒãƒªãƒ¼æƒ…å ± */
        .summary-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #666;
        }

        .summary-value {
            font-weight: bold;
            color: #333;
        }

        /* PDFæƒ…å ±ã‚¿ã‚° */
        .pdf-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .pdf-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 12px;
            color: #1565c0;
        }

        .pdf-tag.kidsline {
            background: #e3f2fd;
            color: #1565c0;
        }

        .pdf-tag.invoice {
            background: #fff3e0;
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="/frontend/pdf-extractor.html">â† æˆ»ã‚‹: PDFã‚’å†é¸æŠ</a>
            <div class="step-indicator">Step 2 / 3</div>
        </div>

        <h1>æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h1>
        <p class="subtitle">çµåˆã•ã‚ŒãŸåˆ©ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ãã ã•ã„</p>

        <div id="successMessage" class="success-message"></div>

        <div id="validationStatus" class="validation-status valid">
            âœ“ ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã§ã™
        </div>

        <!-- ã‚µãƒãƒªãƒ¼æƒ…å ± -->
        <div class="summary-box">
            <div class="summary-item">
                <span class="summary-label">æŠ½å‡ºå…ƒPDF</span>
                <span class="summary-value" id="summaryPdfCount">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">åˆ©ç”¨å›æ•°</span>
                <span class="summary-value" id="summaryRowCount">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">åˆè¨ˆåˆ©ç”¨æ™‚é–“</span>
                <span class="summary-value" id="summaryTotalTime">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">åˆè¨ˆé‡‘é¡</span>
                <span class="summary-value" id="summaryTotalAmount">-</span>
            </div>
            <div class="pdf-tags" id="pdfTags"></div>
        </div>

        <div class="two-column">
            <!-- å·¦ã‚«ãƒ©ãƒ : ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="column">
                <h2>çµåˆãƒ†ãƒ¼ãƒ–ãƒ«</h2>
                <div class="table-preview">
                    <div class="table-header">
                        <span>æŠ½å‡ºãƒ‡ãƒ¼ã‚¿</span>
                        <span id="tableInfo"></span>
                    </div>
                    <div class="table-container">
                        <table id="previewTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ : ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="column">
                <h2>ç”³è«‹æƒ…å ±ã‚’ç·¨é›†</h2>

                <div class="info-box">
                    <p><strong>ãƒ’ãƒ³ãƒˆ:</strong> å¹´åº¦ã€ç”³è«‹è€…åã€å…ç«¥åã‚’ç·¨é›†ã§ãã¾ã™</p>
                </div>

                <div class="form-group">
                    <label for="editYear">å¹´åº¦ï¼ˆä»¤å’Œï¼‰</label>
                    <input type="text" id="editYear" placeholder="ä¾‹: 7">
                    <div id="yearError" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="editApplicantName">ç”³è«‹è€…å</label>
                    <input type="text" id="editApplicantName" placeholder="ä¾‹: æ‰ä¸¦ ãªã¿">
                    <div id="applicantError" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="editChildName">å…ç«¥å</label>
                    <input type="text" id="editChildName" placeholder="ä¾‹: æ‰ä¸¦ ã™ã‘">
                    <div id="childError" class="error-message"></div>
                </div>

                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: bold; color: #666;">JSONãƒ‡ãƒ¼ã‚¿ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰</summary>
                    <div style="margin-top: 15px;">
                        <textarea id="editJsonData" placeholder="JSONãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                        <div id="jsonError" class="error-message"></div>
                    </div>
                </details>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-back" id="backBtn">â† æˆ»ã‚‹</button>
            <button class="btn btn-primary" id="nextToFormBtn">æ¬¡ã¸: ç”³è«‹æ›¸ã‚’è¡¨ç¤º â†’</button>
        </div>
    </div>

    <script>
        const editYear = document.getElementById('editYear');
        const editApplicantName = document.getElementById('editApplicantName');
        const editChildName = document.getElementById('editChildName');
        const editJsonData = document.getElementById('editJsonData');
        const validationStatus = document.getElementById('validationStatus');
        const successMessage = document.getElementById('successMessage');
        const backBtn = document.getElementById('backBtn');
        const nextToFormBtn = document.getElementById('nextToFormBtn');

        const yearError = document.getElementById('yearError');
        const applicantError = document.getElementById('applicantError');
        const childError = document.getElementById('childError');
        const jsonError = document.getElementById('jsonError');

        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const tableInfo = document.getElementById('tableInfo');
        const pdfTags = document.getElementById('pdfTags');

        let jsonData = null;
        let tableData = null;
        let isValid = true;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function loadData() {
            const formDataStr = localStorage.getItem('extractedFormData');
            const tableDataStr = localStorage.getItem('extractedTableData');

            if (!formDataStr) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Step 1ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
                window.location.href = '/frontend/pdf-extractor.html';
                return;
            }

            try {
                jsonData = JSON.parse(formDataStr);
                editYear.value = jsonData.year || '7';
                editApplicantName.value = jsonData.applicantName || '';
                editChildName.value = jsonData.childName || '';
                editJsonData.value = JSON.stringify(jsonData, null, 2);

                // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if (tableDataStr) {
                    tableData = JSON.parse(tableDataStr);
                    displayTable(tableData.mergedTable);
                    displayPdfTags(tableData.results);
                    updateSummary(tableData);
                }

                validateAll();
            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                window.location.href = '/frontend/pdf-extractor.html';
            }
        }

        function displayTable(table) {
            if (!table || table.length === 0) return;

            // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±
            tableInfo.textContent = `${table.length}è¡Œ Ã— ${table[0].length}åˆ—`;

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            tableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            table[0].forEach(cell => {
                const th = document.createElement('th');
                th.textContent = cell || '';
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            tableBody.innerHTML = '';
            for (let i = 1; i < table.length; i++) {
                const tr = document.createElement('tr');
                table[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            }
        }

        function displayPdfTags(results) {
            if (!results || results.length === 0) return;

            pdfTags.innerHTML = '';
            results.forEach(result => {
                const tag = document.createElement('span');
                const formatClass = result.format === 'kidsline' ? 'kidsline' : 'invoice';
                const icon = result.format === 'kidsline' ? 'ğŸ§¾' : 'ğŸ“‹';
                tag.className = `pdf-tag ${formatClass}`;
                tag.innerHTML = `${icon} ${result.filename}`;
                pdfTags.appendChild(tag);
            });
        }

        function updateSummary(tableData) {
            if (!tableData) return;

            // PDFæ•°
            document.getElementById('summaryPdfCount').textContent = `${tableData.results.length}ä»¶`;

            // è¡Œæ•°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤ãï¼‰
            const rowCount = tableData.mergedTable.length - 1;
            document.getElementById('summaryRowCount').textContent = `${rowCount}å›`;

            // åˆè¨ˆæ™‚é–“ã¨é‡‘é¡ã‚’è¨ˆç®—
            let totalMinutes = 0;
            let totalAmount = 0;

            for (let i = 1; i < tableData.mergedTable.length; i++) {
                const row = tableData.mergedTable[i];
                
                // æ™‚é–“è¨ˆç®—ï¼ˆé–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‹ã‚‰ï¼‰
                const startTime = row[1]; // é–‹å§‹æ™‚åˆ»
                const endTime = row[2];   // çµ‚äº†æ™‚åˆ»
                if (startTime && endTime) {
                    try {
                        const [startH, startM] = startTime.split(':').map(Number);
                        const [endH, endM] = endTime.split(':').map(Number);
                        const minutes = (endH * 60 + endM) - (startH * 60 + startM);
                        if (minutes > 0) {
                            totalMinutes += minutes;
                        }
                    } catch (e) {}
                }

                // é‡‘é¡è¨ˆç®—ï¼ˆãŠæ”¯æ‰•ã„é¡ï¼‰
                const amount = row[12]; // ãŠæ”¯æ‰•ã„é¡
                if (amount) {
                    const numAmount = parseInt(String(amount).replace(/,/g, ''), 10);
                    if (!isNaN(numAmount)) {
                        totalAmount += numAmount;
                    }
                }
            }

            // æ™‚é–“è¡¨ç¤º
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            document.getElementById('summaryTotalTime').textContent = `${hours}æ™‚é–“${mins}åˆ†`;

            // é‡‘é¡è¡¨ç¤º
            document.getElementById('summaryTotalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´æ™‚ã«JSONã‚’æ›´æ–°
        function updateJsonFromFields() {
            try {
                const currentData = JSON.parse(editJsonData.value);
                currentData.year = editYear.value;
                currentData.applicantName = editApplicantName.value;
                currentData.childName = editChildName.value;
                jsonData = currentData;
                editJsonData.value = JSON.stringify(currentData, null, 2);
                validateAll();
            } catch (error) {
                // JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }

        // JSONç›´æ¥ç·¨é›†æ™‚ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
        function updateFieldsFromJson() {
            try {
                const currentData = JSON.parse(editJsonData.value);
                jsonData = currentData;
                editYear.value = currentData.year || '';
                editApplicantName.value = currentData.applicantName || '';
                editChildName.value = currentData.childName || '';
                validateAll();
            } catch (error) {
                validateAll();
            }
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateAll() {
            isValid = true;

            // å¹´åº¦
            if (!editYear.value || editYear.value.trim() === '') {
                setError(editYear, yearError, 'å¹´åº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            } else if (!/^\d+$/.test(editYear.value.trim())) {
                setError(editYear, yearError, 'å¹´åº¦ã¯æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            } else {
                clearError(editYear, yearError);
            }

            // ç”³è«‹è€…å
            if (!editApplicantName.value || editApplicantName.value.trim() === '') {
                setError(editApplicantName, applicantError, 'ç”³è«‹è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            } else {
                clearError(editApplicantName, applicantError);
            }

            // å…ç«¥å
            if (!editChildName.value || editChildName.value.trim() === '') {
                setError(editChildName, childError, 'å…ç«¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            } else {
                clearError(editChildName, childError);
            }

            // JSON
            try {
                const parsed = JSON.parse(editJsonData.value);
                if (!parsed.page1 || !parsed.page1.rows) {
                    setError(editJsonData, jsonError, 'JSONãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ï¼ˆpage1.rowsãŒå¿…è¦ï¼‰');
                    isValid = false;
                } else {
                    clearError(editJsonData, jsonError);
                }
            } catch (error) {
                setError(editJsonData, jsonError, 'JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + error.message);
                isValid = false;
            }

            // çµæœè¡¨ç¤º
            if (isValid) {
                validationStatus.className = 'validation-status valid';
                validationStatus.textContent = 'âœ“ ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã§ã™';
                nextToFormBtn.disabled = false;
            } else {
                validationStatus.className = 'validation-status invalid';
                validationStatus.textContent = 'âœ— ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ãã ã•ã„';
                nextToFormBtn.disabled = true;
            }
        }

        function setError(element, errorElement, message) {
            element.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('active');
        }

        function clearError(element, errorElement) {
            element.classList.remove('error');
            errorElement.textContent = '';
            errorElement.classList.remove('active');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        editYear.addEventListener('input', updateJsonFromFields);
        editApplicantName.addEventListener('input', updateJsonFromFields);
        editChildName.addEventListener('input', updateJsonFromFields);
        editJsonData.addEventListener('input', updateFieldsFromJson);

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        backBtn.addEventListener('click', function() {
            if (confirm('ç·¨é›†å†…å®¹ã‚’ç ´æ£„ã—ã¦PDFæŠ½å‡ºç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = '/frontend/pdf-extractor.html';
            }
        });

        // æ¬¡ã¸ãƒœã‚¿ãƒ³
        nextToFormBtn.addEventListener('click', function() {
            if (!isValid) {
                alert('ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰æ¬¡ã«é€²ã‚“ã§ãã ã•ã„');
                return;
            }

            try {
                const finalData = JSON.parse(editJsonData.value);
                finalData.year = editYear.value.trim();
                finalData.applicantName = editApplicantName.value.trim();
                finalData.childName = editChildName.value.trim();
                localStorage.setItem('extractedFormData', JSON.stringify(finalData));
                window.location.href = '/frontend/babysitter-form.html?loadExtracted=true';
            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // åˆæœŸåŒ–
        loadData();
    </script>
</body>
</html>
